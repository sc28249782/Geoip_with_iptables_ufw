---


---

<h2 id="setting-geoip-capabilities-with-ufwiptables--with-automatic-ip-addr-db-updates-on-cloudpanel-hosting.">Setting Geoip capabilities with ufw/iptables  with automatic IP addr db updates on CloudPanel Hosting.</h2>
<ol>
<li><code>sudo apt install curl perl unzip xtables-addons-common libtext-csv-xs-perl libmoosex-types-netaddr-ip-perl</code></li>
<li>Prepare GeoIP database manually</li>
</ol>
<pre><code>sudo mkdir /usr/share/xt_geoip
cd /usr/share/xt_geoip
sudo /usr/libexec/xtables-addons/xt_geoip_dl
sudo /usr/libexec/xtables-addons/xt_geoip_build -s -i dbip*.csv
</code></pre>
<ol start="4">
<li>Put this into  <code>/etc/cron.weekly/geoip-update</code></li>
</ol>
<pre><code>#!/bin/bash -e

WORKDIR=`mktemp -d`
if [[ ! "$WORKDIR" || ! -d "$WORKDIR" ]]; then
        echo "Error: Could not create temp dir on $(date)" &gt;&gt; /var/log/geoip_update.log
        exit 1
fi

cd $WORKDIR
/usr/libexec/xtables-addons/xt_geoip_dl
/usr/libexec/xtables-addons/xt_geoip_build -q -s -i dbip*.csv

# Clean up WORKDIR
cd /tmp
rm -rf $WORKDIR

# Reload UFW so rules using geoip match new database
ufw reload

# Log the cleanup activity
echo "Weekly geoip update completed on $(date)" &gt;&gt; /var/log/geoip_update.log
</code></pre>
<p>Then,</p>
<p><code>chmod +x /etc/cron.weekly/geoip-update</code></p>
<p>Test <code>/etc/cron.weekly/</code> with <code>run-parts</code></p>
<p><code>run-parts --test /etc/cron.weekly/</code></p>
<p>This line should appear on the output</p>
<p><code>/etc/cron.weekly//geoip-update</code></p>
<ol start="3">
<li><code>modprobe xt_geoip</code><br>
and check</li>
</ol>
<p><code>lsmod | grep ^xt_geoip</code></p>
<p>The output should be similar to this.</p>
<pre><code>xt_geoip             16384  34
</code></pre>
<ol start="5">
<li>Add rules to UFW file “<code>/etc/ufw/before.rules</code>”. Prepend before  <code>COMMIT</code>  (at the very end).</li>
</ol>
<pre><code>#### CUSTOM EXAMPLE:
# block all traffic from RU,CN
-A ufw-before-input -p tcp -m geoip --src-cc RU,CN -j DROP

# block all traffic to port 22 from all ips except TH
-A ufw-before-input -p tcp --dport 22 -m geoip ! --src-cc TH -j DROP

# Allow TH
-A ufw-before-input -m geoip --src-cc TH -j ACCEPT

# Log non-TH traffic
-A ufw-before-input -m geoip ! --src-cc TH -j LOG --log-prefix "[UFW BLOCKED COUNTRIES] "

# Drop non-TH traffic
-A ufw-before-input -m geoip ! --src-cc TH -j DROP
#### END CUSTOM
</code></pre>
<ol start="6">
<li>Reload UFW<br>
<code>ufw reload</code></li>
</ol>
<h2 id="automated-country-stats-script">Automated country stats script</h2>
<p><strong>Use <code>geoiplookup</code> (simpler)</strong></p>
<p>Ubuntu has the <code>geoip-bin</code> package which gives <code>geoiplookup</code>:</p>
<p><code>sudo apt install geoip-bin</code></p>
<p>Then test:</p>
<p><code>geoiplookup 8.8.8.8</code></p>
<p>Output:</p>
<p><code>GeoIP Country Edition: US, United States</code></p>
<p>Get only country code:</p>
<p><code>country=$(geoiplookup "$ip" | awk -F: '{print $2}' | awk -F, '{print $1}' | sed "s/^ *//;s/ *$//")</code></p>
<p>Create <code>/usr/local/bin/geoip-drop-stats.sh</code>:</p>
<pre><code>#!/bin/bash
LOGFILE="/var/log/ufw.log"
TMPFILE="/tmp/geoip-ips.txt"

# Extract dropped IPs
grep "UFW BLOCKED COUNTRIES" "$LOGFILE" | awk '{for(i=1;i&lt;=NF;i++){if($i ~ /^SRC=/){print substr($i,5)}}}' | sort -u &gt; "$TMPFILE"

echo "===== Blocked connections by country ====="
while read -r ip; do
    country=$(geoiplookup "$ip" | awk -F: '{print $2}' | awk -F, '{print $1}' | sed "s/^ *//;s/ *$//")
    echo "$country"
done &lt; "$TMPFILE" | sort | uniq -c | sort -nr
</code></pre>
<p>Make executable:</p>
<p><code>sudo chmod +x /usr/local/bin/geoip-drop-stats.sh</code></p>
<p>Run:</p>
<p><code>sudo /usr/local/bin/geoip-drop-stats.sh</code></p>
<p>Example output:</p>
<pre><code>===== Blocked connections by country =====
    145 US
     19 VN
     14 CN
     14 AU
      9 SG
      9 AR
      6 GB
</code></pre>
<h2 id="cloudpanel-ufw-tweak">CloudPanel UFW Tweak</h2>
<p>After Add/Edit and Save firewall rules in Security/Firewall menu on Admin Area, CloudPanel will reset <code>ufw before.rules</code> and afrer.rules to default.</p>
<p>The default rules of ufw are located in <code>/usr/share/ufw/iptables</code>.</p>
<p>Firstly backup the old rules.</p>
<pre><code>cd /usr/share/ufw/iptables
mv before.rules before.rules.ORIG
</code></pre>
<p>Then copy our before.rules</p>
<pre><code>cd /usr/share/ufw/iptables
cp /etc/ufw/before.rules .
</code></pre>
<p>OK, now you can Add/Edit and Save firewall rules in Security/Firewall menu on CloudPanel without effect on <code>before.rules</code> with xtables geoip.</p>

